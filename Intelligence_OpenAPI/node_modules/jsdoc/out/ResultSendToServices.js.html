<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ResultSendToServices.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ResultSendToServices.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>//slack config
const {WebClient} = require('@slack/client')
const token = 'xoxp-401187969874-400943764356-429588191991-fd8e255bcf9ee5b0ed296e6115fbd0ac'
const web = new WebClient(token)
const Request= require('request')

//mailer config
const nodemailer = require('nodemailer')

/**
 * @name sendToSlack 
 * @description slack으로 콜백
 * @method
 * @param {String} message - 보낼 메시지
 * @param {String} conversationId - 슬랙 개인별 고유 아이디
 * @param {requestCallback} callback - 보내는데 걸리는 시간
 * @module 결과callback
 */
function sendToSlack(message, conversationId, callback) {
  web.chat.postMessage({channel:conversationId, text: message})
  .then((res)=> {
    callback(res.ts)
  }).catch(console.error)
}

module.exports = {
  /**
   * @name sendToService
   * @description callback 서비스 slack email 구분
   * @method
   * @param {String} req.body.target -slack, email target id
   * @param {String} req.body.stdout - spark 앱 결과값
   * @param {String} req.body.user - email, slack id 정보
   * @module 결과callback
   */
  sendToService(req, res) {
    const target = req.body.target
    const stdout = req.body.stdout
    const user = req.body.user
    if (target == "slack") {
      checkUser(user, function(result) {
        if (!result) {
          res.send({status:false, result: "slack user not found"})
        } else {
          sendToSlack("result : " + stdout, result, function(response){  
            res.send({status: true, result: stdout})
          })
        }
      })
    } else if(target == "email") {
      sendToEmail("result : "+stdout, user, function(response) {
        res.send({status: true, result: stdout})
      })
    } else {}
  }
}
/**
 * @name sendToEmail
 * @description 이메일 보내기
 * @method
 * @param {String} message - 보낼 메세지
 * @param {String} ToMailName - 보낼 대상 이메일
 * @param {requestCallback} callback - error, info
 * @module 결과callback
 */
function sendToEmail(message, ToMailName, callback) {
      let transport = nodemailer.createTransport({
          service : 'gmail',
          auth: {
              user: 'guildzeta@gmail.com',
              pass: 'dksdidzja1'
          }
      })
      let mailOptions = {
          from: 'guildzeta@gmail.com',
          to: ToMailName,
          subject: 'spark result',
          html: '&lt;h1> result &lt;/h1>' +
                '&lt;p>'+ message +'&lt;/p>'
      }
      transport.sendMail(mailOptions, function(error, info){
          if(error){
              console.log(error)
              callback(error)
          } else {
              console.log(info)
              callback(info)
          }
      })
  }
  /**
   * @name checkUser
   * @description slack user인지 체크
   * @method
   * @param {String} id - slakc email
   * @param {requestCallback} callback - slack 유저 id 
   * @module 결과callback
   */
  function checkUser(id, callback) {
    Request({
      method: 'get',
      url: `https://slack.com/api/rtm.start?token=${token}&amp;pretty=1`,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
      }
    }, function(err, response, body){
      try{
        if(!err &amp;&amp; response.statusCode ==200){
          const result = JSON.parse(body)
          const users = result.users
          for (let i in users) {
            if (users[i].name == id ) {
              let ims = result.ims
              for (let j in ims) {
                if (ims[j].user == users[i].id){
                  callback(ims[j].id)
                  return
                }
              }
            }
          }
        }
      }catch(e){
        console.log(e)
        callback(false)
        return
      }
    })
  }</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-admin%2525252525EC%252525252584%25252525259C%2525252525EB%2525252525B9%252525252584%2525252525EC%25252525258A%2525252525A4.html">admin서비스</a></li><li><a href="module-client%2525252525EC%252525252584%25252525259C%2525252525EB%2525252525B9%252525252584%2525252525EC%25252525258A%2525252525A4.html">client서비스</a></li><li><a href="module-login%25252525EC%2525252584%252525259C%25252525EB%25252525B9%2525252584%25252525EC%252525258A%25252525A4.html">login서비스</a></li><li><a href="module-yarn%252525EC%25252583%25252581%252525ED%25252583%2525259C.html">yarn상태</a></li><li><a href="module-%25252525EA%25252525B2%25252525B0%25252525EA%25252525B3%25252525BCcallback.html">결과callback</a></li><li><a href="module-%25EC%258A%25A4%25ED%258C%258C%25ED%2581%25AC%25EC%2595%25B1%25EC%258B%25A4%25ED%2596%2589.html">스파크앱실행</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Sep 19 2018 16:41:06 GMT+0900 (대한민국 표준시)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
